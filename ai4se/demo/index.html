<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI4SE Health Assistant - Offline Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .status.online {
            background: #4CAF50;
        }

        .status.loading {
            background: #FF9800;
        }

        .status.offline {
            background: #F44336;
        }

        .content {
            padding: 30px;
        }

        .model-info {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .model-info h3 {
            color: #2E7D32;
            margin-bottom: 15px;
        }

        .model-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
            background: white;
        }

        .load-btn {
            background: #2E7D32;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }

        .load-btn:hover {
            background: #1B5E20;
        }

        .load-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2E7D32 0%, #4CAF50 100%);
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        .chat-container {
            border: 2px solid #ddd;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
            display: none;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #E3F2FD;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: #E8F5E9;
        }

        .message.system {
            background: #FFF3E0;
            font-style: italic;
            max-width: 100%;
            text-align: center;
        }

        .input-area {
            display: none;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .send-btn {
            background: #2E7D32;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .send-btn:hover {
            background: #1B5E20;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .examples {
            margin-top: 20px;
        }

        .examples h4 {
            color: #2E7D32;
            margin-bottom: 10px;
        }

        .example-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-block;
        }

        .example-btn:hover {
            background: #E8F5E9;
            border-color: #2E7D32;
        }

        .info-box {
            background: #E3F2FD;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning-box {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2E7D32;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            .stats {
                grid-template-columns: 1fr;
            }

            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• AI4SE Health Assistant</h1>
            <p>Offline AI-Powered Medical Triage</p>
            <span class="status offline" id="status">‚ö†Ô∏è Model Not Loaded</span>
        </div>

        <div class="content">
            <!-- Model Info Section -->
            <div class="model-info">
                <h3>ü§ñ Local AI Model</h3>
                <p style="margin-bottom: 15px;">This demo uses WebLLM to run AI models directly in your browser. No data is sent to servers - everything runs locally on your device.</p>

                <select class="model-select" id="modelSelect">
                    <option value="Llama-3.2-3B-Instruct-q4f16_1-MLC">Llama 3.2 3B (Recommended) - ~1.9 GB</option>
                    <option value="Phi-3-mini-4k-instruct-q4f16_1-MLC">Phi-3 Mini (Faster) - ~2.3 GB</option>
                    <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (Lighter) - ~0.6 GB</option>
                </select>

                <button class="load-btn" id="loadBtn">Load Model</button>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-bar-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Initializing...</div>
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è System Requirements:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li>Chrome 113+ or Edge 113+ (WebGPU support)</li>
                    <li>At least 4 GB RAM</li>
                    <li>First load will download ~2 GB (cached for offline use)</li>
                    <li>Subsequent loads are instant from cache</li>
                </ul>
            </div>

            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <div class="message system">
                    Welcome! I'm your offline medical assistant. I can help with initial health assessments, but I'm not a replacement for professional medical care. In emergencies, always seek immediate medical attention.
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area" id="inputArea">
                <div class="input-container">
                    <input
                        type="text"
                        class="message-input"
                        id="messageInput"
                        placeholder="Describe the symptoms..."
                        onkeypress="if(event.key === 'Enter') sendMessage()"
                    >
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
                </div>

                <div class="examples">
                    <h4>üí° Example Questions:</h4>
                    <button class="example-btn" onclick="setExample('My child has fever and diarrhea for 3 days')">
                        Fever & Diarrhea
                    </button>
                    <button class="example-btn" onclick="setExample('I have a persistent cough and chest pain')">
                        Cough & Chest Pain
                    </button>
                    <button class="example-btn" onclick="setExample('My baby is not eating and seems lethargic')">
                        Baby Not Eating
                    </button>
                    <button class="example-btn" onclick="setExample('I have a severe headache with sensitivity to light')">
                        Severe Headache
                    </button>
                </div>
            </div>

            <!-- Info Box -->
            <div class="info-box">
                <strong>üîí Privacy & Security:</strong>
                <p style="margin-top: 10px;">
                    All processing happens in your browser. No data is sent to external servers.
                    This is a demonstration of local-first AI technology for resource-constrained environments.
                </p>
            </div>

            <!-- Statistics -->
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="statTokens">0</div>
                    <div class="stat-label">Tokens Generated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statSpeed">0</div>
                    <div class="stat-label">Tokens/Second</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statQueries">0</div>
                    <div class="stat-label">Total Queries</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        let engine = null;
        let conversationHistory = [];
        let totalTokens = 0;
        let totalQueries = 0;

        const systemPrompt = `You are a medical assistant designed to help with primary health assessment in resource-limited settings. Your role is to:

1. Ask relevant questions about symptoms
2. Provide initial assessment and guidance
3. Suggest immediate actions that can be taken at home
4. Identify when professional medical care is urgently needed
5. Be culturally sensitive and use simple, clear language

Important guidelines:
- Always emphasize that you're providing initial guidance, not diagnosis
- For serious symptoms, strongly recommend seeking medical care
- Provide practical advice using locally available resources
- Be empathetic and supportive
- If unsure, err on the side of caution and recommend professional care

Remember: You're a first-contact tool, not a replacement for medical professionals.`;

        window.loadModel = async function() {
            const loadBtn = document.getElementById('loadBtn');
            const modelSelect = document.getElementById('modelSelect');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const status = document.getElementById('status');
            const chatContainer = document.getElementById('chatContainer');
            const inputArea = document.getElementById('inputArea');
            const stats = document.getElementById('stats');

            const selectedModel = modelSelect.value;

            loadBtn.disabled = true;
            modelSelect.disabled = true;
            progressBar.style.display = 'block';
            progressText.style.display = 'block';
            status.textContent = '‚è≥ Loading Model...';
            status.className = 'status loading';

            try {
                engine = await webllm.CreateMLCEngine(selectedModel, {
                    initProgressCallback: (progress) => {
                        const percentage = Math.round(progress.progress * 100);
                        progressFill.style.width = percentage + '%';
                        progressText.textContent = progress.text || `Loading... ${percentage}%`;
                        console.log(progress);
                    }
                });

                // Model loaded successfully
                status.textContent = 'üü¢ Offline Mode - Ready';
                status.className = 'status online';
                progressText.textContent = 'Model loaded! Ready for offline use.';
                chatContainer.style.display = 'block';
                inputArea.style.display = 'block';
                stats.style.display = 'grid';

                // Add system message
                conversationHistory.push({
                    role: "system",
                    content: systemPrompt
                });

                console.log("Model loaded successfully!");
            } catch (error) {
                status.textContent = '‚ùå Error Loading Model';
                status.className = 'status offline';
                progressText.textContent = 'Error: ' + error.message;
                loadBtn.disabled = false;
                modelSelect.disabled = false;
                console.error("Error loading model:", error);
            }
        };

        window.sendMessage = async function() {
            if (!engine) {
                alert('Please load the model first!');
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            const chatContainer = document.getElementById('chatContainer');
            const sendBtn = document.getElementById('sendBtn');

            // Add user message to UI
            addMessage(message, 'user');
            input.value = '';
            sendBtn.disabled = true;

            // Add to conversation history
            conversationHistory.push({
                role: "user",
                content: message
            });

            // Create assistant message placeholder
            const assistantMsgDiv = document.createElement('div');
            assistantMsgDiv.className = 'message assistant';
            assistantMsgDiv.textContent = 'Thinking...';
            chatContainer.appendChild(assistantMsgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const startTime = Date.now();
                let fullResponse = '';
                let tokenCount = 0;

                // Stream the response
                const chunks = await engine.chat.completions.create({
                    messages: conversationHistory,
                    stream: true,
                    max_tokens: 512,
                    temperature: 0.7
                });

                assistantMsgDiv.textContent = '';

                for await (const chunk of chunks) {
                    const content = chunk.choices[0]?.delta?.content || "";
                    fullResponse += content;
                    assistantMsgDiv.textContent = fullResponse;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    tokenCount++;
                }

                // Add to conversation history
                conversationHistory.push({
                    role: "assistant",
                    content: fullResponse
                });

                // Update statistics
                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;
                const tokensPerSecond = Math.round(tokenCount / duration);

                totalTokens += tokenCount;
                totalQueries++;

                document.getElementById('statTokens').textContent = totalTokens;
                document.getElementById('statSpeed').textContent = tokensPerSecond;
                document.getElementById('statQueries').textContent = totalQueries;

            } catch (error) {
                assistantMsgDiv.textContent = '‚ùå Error: ' + error.message;
                console.error("Error generating response:", error);
            }

            sendBtn.disabled = false;
            input.focus();
        };

        window.setExample = function(text) {
            document.getElementById('messageInput').value = text;
            document.getElementById('messageInput').focus();
        };

        function addMessage(text, type) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Initialize
        document.getElementById('loadBtn').addEventListener('click', loadModel);
    </script>
</body>
</html>
